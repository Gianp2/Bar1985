// admin.js
import { auth, db, signInWithEmailAndPassword, onAuthStateChanged, signOut, collection, query, orderBy, onSnapshot, doc, deleteDoc } from './firebase.js';

// Cambia este UID por el de tu administrador
const ADMIN_UID = 'YqhSLbtSjHdkj4pfjrfinMZMxut1';

// Elementos del DOM
const loginArea = document.getElementById('loginArea');
const adminArea = document.getElementById('adminArea');
const userEmailSpan = document.getElementById('userEmail');
const tblBody = document.querySelector('#tblReservas tbody');

const loginForm = document.getElementById('loginForm');
const loginBtn = document.getElementById('loginBtn');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const emailError = document.getElementById('emailError');
const passwordError = document.getElementById('passwordError');

const filterName = document.getElementById('filterName');
const filterDate = document.getElementById('filterDate');

const confirmModal = document.getElementById('confirmModal');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

const homeBtn = document.getElementById('homeBtn');

let deleteDocId = null;

// ---------------------------
// Toast notification
// ---------------------------
function showToast(msg, isSuccess = true) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.className = `toast ${isSuccess ? 'success' : 'error'}`;
  toast.setAttribute('role', 'alert');
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ---------------------------
// Escape HTML para seguridad
// ---------------------------
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (c) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[c]);
}

// ---------------------------
// Login form
// ---------------------------
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  emailError.textContent = '';
  passwordError.textContent = '';

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  if (!email) {
    emailError.textContent = 'El correo electrónico es requerido';
    return;
  }
  if (!/\S+@\S+\.\S+/.test(email)) {
    emailError.textContent = 'Ingrese un correo electrónico válido';
    return;
  }
  if (!password) {
    passwordError.textContent = 'La contraseña es requerida';
    return;
  }

  loginBtn.disabled = true;
  loginBtn.textContent = 'Cargando...';

  try {
    await signInWithEmailAndPassword(auth, email, password);
    showToast('Ingreso exitoso', true);
  } catch (err) {
    console.error('Error al iniciar sesión:', err);
    let errorMessage = 'Error al iniciar sesión. Intenta de nuevo.';
    if (err.code === 'auth/wrong-password') errorMessage = 'Contraseña incorrecta.';
    else if (err.code === 'auth/user-not-found') errorMessage = 'Usuario no encontrado.';
    else if (err.code === 'auth/api-key-not-valid.-please-pass-a-valid-api-key') errorMessage = 'Clave API no válida. Contacta al administrador.';
    showToast(errorMessage, false);
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Ingresar';
  }
});

// ---------------------------
// Logout
// ---------------------------
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await signOut(auth);
    showToast('Sesión cerrada', true);
  } catch (err) {
    console.error('Error al cerrar sesión:', err);
    showToast('Error al cerrar sesión', false);
  }
});

// ---------------------------
// Home button
// ---------------------------
homeBtn.addEventListener('click', () => {
  window.location.href = './index.html';
});

// ---------------------------
// Populate table
// ---------------------------
function populateTable(snap) {
  tblBody.innerHTML = '';
  snap.forEach((doc) => {
    const r = doc.data();
    if (shouldDisplayRow(r)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.nombre || '')}</td>
        <td>${escapeHtml(r.telefono || '')}</td>
        <td>${escapeHtml(r.fecha || '')}</td>
        <td>${escapeHtml(r.hora || '')}</td>
        <td>${escapeHtml(r.tipo || '')}</td>
        <td><button class="action-btn" data-id="${doc.id}" aria-label="Eliminar reserva">Eliminar</button></td>
      `;
      tblBody.appendChild(tr);
    }
  });

  // Event listeners para botones eliminar
  document.querySelectorAll('.action-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      deleteDocId = btn.dataset.id;
      confirmModal.style.display = 'flex';
      confirmModal.setAttribute('aria-hidden', 'false');
      confirmDeleteBtn.focus();
    });
  });
}

// ---------------------------
// Filtrado
// ---------------------------
function shouldDisplayRow(data) {
  const nameFilter = filterName.value.trim().toLowerCase();
  const dateFilter = filterDate.value;
  const matchesName = !nameFilter || (data.nombre || '').toLowerCase().includes(nameFilter);
  const matchesDate = !dateFilter || (data.fecha || '') === dateFilter;
  return matchesName && matchesDate;
}

// ---------------------------
// Eventos filtros
// ---------------------------
filterName.addEventListener('input', () => {
  const q = query(collection(db, 'reservas'), orderBy('createdAt', 'desc'));
  onSnapshot(q, (snap) => populateTable(snap));
});

filterDate.addEventListener('change', () => {
  const q = query(collection(db, 'reservas'), orderBy('createdAt', 'desc'));
  onSnapshot(q, (snap) => populateTable(snap));
});

// ---------------------------
// Modal eliminar
// ---------------------------
confirmDeleteBtn.addEventListener('click', async () => {
  if (deleteDocId) {
    try {
      await deleteDoc(doc(db, 'reservas', deleteDocId));
      showToast('Reserva eliminada con éxito', true);
    } catch (err) {
      console.error('Error al eliminar reserva:', err);
      showToast('Error al eliminar reserva', false);
    }
    deleteDocId = null;
    confirmModal.style.display = 'none';
    confirmModal.setAttribute('aria-hidden', 'true');
  }
});

cancelDeleteBtn.addEventListener('click', () => {
  deleteDocId = null;
  confirmModal.style.display = 'none';
  confirmModal.setAttribute('aria-hidden', 'true');
});

confirmModal.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    deleteDocId = null;
    confirmModal.style.display = 'none';
    confirmModal.setAttribute('aria-hidden', 'true');
  }
});

// ---------------------------
// Observador de sesión
// ---------------------------
onAuthStateChanged(auth, (user) => {
  if (user && user.uid === ADMIN_UID) {
    loginArea.style.display = 'none';
    adminArea.style.display = 'block';
    userEmailSpan.textContent = user.email || 'Usuario';

    const q = query(collection(db, 'reservas'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snap) => populateTable(snap), (err) => {
      console.error('Error al cargar reservas:', err);
      showToast('Error al cargar reservas', false);
    });
  } else {
    loginArea.style.display = 'block';
    adminArea.style.display = 'none';
    confirmModal.style.display = 'none';
  }
});
